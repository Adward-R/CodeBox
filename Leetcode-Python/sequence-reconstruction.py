__author__ = 'Adward'
from time import time
class Solution(object):
    def sequenceReconstruction(self, org, seqs):
        """
        :param org: List[int]
        :param seqs: List[List[int]]
        :return: bool
        """
        if len(seqs) == 0:
            return False
        n = max((max(seq) for seq in seqs if len(seq)))  # [[1,2],[2,3],[]]
        if len(org) != n:
            return False
        succ = [set() for _ in range(n+1)]
        prev = [set() for _ in range(n+1)]
        indegree = [0] * (n+1)

        for seq in seqs:
            m = len(seq)
            for i in range(m-1):
                n1, n2 = seq[i], seq[i+1]
                if n1 == n2 or n1 < 1 or n2 < 1:
                    return False
                succ[n1].add(n2)
                prev[n2].add(n1)

        for i in range(1, n+1):
            indegree[i] = len(prev[i])
            if indegree[i] == 0:
                succ[0].add(i)
                indegree[i] = 1

        nxt, p = 0, 0
        while p < len(org):
            _nxt = nxt
            nxt = 0
            for i in succ[_nxt]:
                indegree[i] -= 1
                if indegree[i] == 0:
                    if nxt or i != org[p]:
                        return False
                    else:
                        nxt = i
            if nxt == 0:
                return False
            p += 1

        return True

sol = Solution()
org = [1,2,3]
seqs = [[1,2,3], [1,3,2]]
org = [366,237,863,811,74,121,426,356,895,883,16,767,546,576,403,192,946,225,367,685,889,228,288,996,566,852,264,822,424,979,625,291,86,988,435,804,308,629,187,201,52,632,815,921,150,798,206,633,610,871,335,513,569,27,316,980,563,181,582,553,472,289,470,166,636,332,663,901,860,994,406,764,160,529,229,965,152,103,873,26,753,153,934,365,358,845,738,249,995,585,211,244,14,461,533,495,978,129,622,99,623,961,757,489,43,71,342,193,520,779,457,932,353,797,85,803,276,698,973,774,176,905,373,506,908,76,864,655,319,66,904,631,215,336,516,899,725,134,509,838,77,572,305,763,537,114,602,58,878,412,232,120,639,640,301,417,554,64,661,271,275,47,90,558,504,402,418,235,22,653,493,527,619,8,112,859,787,561,962,942,355,265,459,907,927,709,805,324,462,547,287,94,446,809,465,115,136,339,381,200,618,104,126,571,477,736,521,41,604,786,198,545,911,297,617,425,511,259,191,915,382,333,922,379,156,926,821,523,575,530,528,712,285,690,870,950,398,343,223,841,32,846,113,929,896,238,754,620,456,769,755,433,81,95,828,230,299,107,374,498,359,57,3,789,360,309,645,748,257,940,218,478,175,982,884,208,79,423,832,941,427,778,710,204,593,487,325,920,659,970,552,890,252,142,111,600,534,722,947,151,989,296,998,169,510,182,197,96,2,716,199,370,869,183,97,53,348,500,612,154,484,387,592,399,149,734,185,173,524,791,294,60,691,590,213,421,242,323,352,354,256,62,756,468,976,812,11,216,936,220,240,514,839,714,833,420,368,746,286,643,957,862,407,983,570,881,959,318,992,937,781,679,958,268,161,236,720,295,733,799,917,396,106,378,178,124,163,283,823,117,463,46,471,538,818,361,6,564,588,222,503,82,340,63,364,376,760,122,589,159,666,816,494,327,344,1,577,776,654,507,872,24,596,903,1000,750,611,168,630,682,61,210,486,688,541,739,551,116,263,209,835,990,856,7,681,944,695,581,310,127,351,23,758,505,405,924,656,65,825,320,440,482,742,282,18,891,35,125,780,133,853,241,671,36,300,768,800,847,400,442,704,281,101,933,850,428,362,918,17,279,624,806,706,615,813,217,584,752,670,708,179,205,5,583,867,395,931,635,441,239,775,451,777,678,550,951,56,219,45,224,802,857,9,274,350,91,518,401,999,430,900,474,796,315,730,693,831,248,502,807,165,826,260,98,508,162,458,887,609,741,723,948,515,253,886,788,158,413,696,207,928,694,848,105,132,606,447,637,669,448,436,749,559,312,196,272,190,782,686,29,649,717,174,938,195,985,328,651,157,854,445,233,793,906,913,247,499,963,727,660,303,186,945,130,30,955,792,697,189,25,497,88,969,75,579,466,50,964,935,578,700,72,539,820,438,765,772,675,939,707,411,827,843,565,284,557,836,648,535,372,783,410,70,347,73,293,875,810,762,598,431,78,481,861,512,599,321,83,397,59,155,483,34,377,605,450,188,743,202,522,432,613,984,662,31,974,657,108,773,171,597,689,380,808,33,702,243,92,536,844,408,849,586,877,594,794,258,429,894,393,879,135,346,747,949,292,330,385,139,658,234,454,626,496,542,667,684,971,993,123,943,391,302,4,404,452,735,419,118,84,634,711,21,490,147,269,246,916,766,20,925,131,491,443,568,298,137,751,731,732,273,525,991,214,389,960,567,203,650,54,953,607,119,68,674,363,266,834,306,997,737,902,851,231,646,221,865,549,329,608,745,475,898,880,357,876,866,573,464,817,540,562,172,840,680,701,952,919,390,770,15,819,19,143,250,10,728,80,338,384,526,842,975,830,721,245,692,986,51,703,855,910,226,761,334,687,744,314,311,87,100,977,784,601,141,801,109,621,966,434,345,544,102,888,968,713,469,641,28,251,517,317,724,307,280,341,148,444,560,644,668,627,912,262,144,699,386,824,146,138,718,394,227,476,595,93,676,69,603,437,923,740,409,371,587,726,882,715,759,956,967,719,388,453,180,492,652,392,39,255,664,110,987,375,556,331,647,785,614,254,170,485,893,591,972,874,313,673,177,369,278,304,455,128,473,449,167,277,488,12,543,145,519,885,628,415,829,67,642,909,705,501,677,164,480,897,290,580,48,49,790,672,548,479,270,930,267,422,555,261,414,184,322,858,795,467,37,837,868,38,532,40,439,683,729,55,13,349,665,814,383,638,416,194,892,42,616,981,574,89,914,954,460,326,212,44,771,337,140,531]
seqs = [[366,237,863,811,74,121,426,356,895,883,16,767,546,576,403,192,946,225,367,685,889,228,288,996,566,852,264,822,424,979,625,291,86,988,435,804,308,629,187,201,52,632,815,921,150,798,206,633,610,871,335,513,569,27,316,980,563,181,582,553,472,289,470,166,636,332,663,901,860,994,406,764,160,529,229,965,152,103,873,26,753,153,934,365,358,845,738,249,995,585,211,244,14,461,533,495,978,129,622,99,623,961,757,489,43,71,342,193,520,779,457,932,353,797,85,803,276,698,973,774,176,905,373,506,908,76,864,655,319,66,904,631,215,336,516,899,725,134,509,838,77,572,305,763,537,114,602,58,878,412,232,120,639,640,301,417,554,64,661,271,275,47,90,558,504,402,418,235,22,653,493,527,619,8,112,859,787,561,962,942,355,265,459,907,927,709,805,324,462,547,287,94,446,809,465,115,136,339,381,200,618,104,126,571,477,736,521,41,604,786,198,545,911,297,617,425,511,259,191,915,382,333,922,379,156,926,821,523,575,530,528,712,285,690,870,950,398,343,223,841,32,846,113,929,896,238,754,620,456,769,755,433,81,95,828,230,299,107,374,498,359,57,3,789,360,309,645,748,257,940,218,478,175,982,884,208,79,423,832,941,427,778,710,204,593,487,325,920,659,970,552,890,252,142,111,600,534,722,947,151,989,296,998,169,510,182,197,96,2,716,199,370,869,183,97,53,348,500,612,154,484,387,592,399,149,734,185,173,524,791,294,60,691,590,213,421,242,323,352,354,256,62,756,468,976,812,11,216,936,220,240,514,839,714,833,420,368,746,286,643,957,862,407,983,570,881,959,318,992,937,781,679,958,268,161,236,720,295,733,799,917,396,106,378,178,124,163,283,823,117,463,46,471,538,818,361,6,564,588,222,503,82,340,63,364,376,760,122,589,159,666,816,494,327,344,1,577,776,654,507,872,24,596,903,1000,750,611,168,630,682,61,210,486,688,541,739,551,116,263,209,835,990,856,7,681,944,695,581,310,127,351,23,758,505,405,924,656,65,825,320,440,482,742,282,18,891,35,125,780,133,853,241,671,36,300,768,800,847,400,442,704,281,101,933,850,428,362,918,17,279,624,806,706,615,813,217,584,752,670,708,179,205,5,583,867,395,931,635,441,239,775,451,777,678,550,951,56,219,45,224,802,857,9,274,350,91,518,401,999,430,900,474,796,315,730,693,831,248,502,807,165,826,260,98,508,162,458,887,609,741,723,948,515,253,886,788,158,413,696,207,928,694,848,105,132,606,447,637,669,448,436,749,559,312,196,272,190,782,686,29,649,717,174,938,195,985,328,651,157,854,445,233,793,906,913,247,499,963,727,660,303,186,945,130,30,955,792,697,189,25,497,88,969,75,579,466,50,964,935,578,700,72,539,820,438,765,772,675,939,707,411,827,843,565,284,557,836,648,535,372,783,410,70,347,73,293,875,810,762,598,431,78,481,861,512,599,321,83,397,59,155,483,34,377,605,450,188,743,202,522,432,613,984,662,31,974,657,108,773,171,597,689,380,808,33,702,243,92,536,844,408,849,586,877,594,794,258,429,894,393,879,135,346,747,949,292,330,385,139,658,234,454,626,496,542,667,684,971,993,123,943,391,302,4,404,452,735,419,118,84,634,711,21,490,147,269,246,916,766,20,925,131,491,443,568,298,137,751,731,732,273,525,991,214,389,960,567,203,650,54,953,607,119,68,674,363,266,834,306,997,737,902,851,231,646,221,865,549,329,608,745,475,898,880,357,876,866,573,464,817,540,562,172,840,680,701,952,919,390,770,15,819,19,143,250,10,728,80,338,384,526,842,975,830,721,245,692,986,51,703,855,910,226,761,334,687,744,314,311,87,100,977,784,601,141,801,109,621,966,434,345,544,102,888,968,713,469,641,28,251,517,317,724,307,280,341,148,444,560,644,668,627,912,262,144,699,386,824,146,138,718,394,227,476,595,93,676,69,603,437,923,740,409,371,587,726,882,715,759,956,967,719,388,453,180,492,652,392,39,255,664,110,987,375,556,331,647,785,614,254,170,485,893,591,972,874,313,673,177,369,278,304,455,128,473,449,167,277,488,12,543,145,519,885,628,415,829,67,642,909,705,501,677,164,480,897,290,580,48,49,790,672,548,479,270,930,267,422,555,261,414,184,322,858,795,467,37,837,868,38,532,40,439,683,729,55,13,349,665,814,383,638,416,194,892,42,616,981,574,89,914,954,460,326,212,44,771,337,140,531]]
print(sol.sequenceReconstruction(org, seqs))